# 社交聊天H5应用 - 技术架构文档

## 1. 架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层 (Client)                      │
├─────────────────────────────────────────────────────────────┤
│  React H5应用                                                │
│  ├─ UI组件层 (Ant Design Mobile/Vant)                       │
│  ├─ 状态管理层 (Redux Toolkit/Zustand)                      │
│  ├─ 路由层 (React Router)                                   │
│  ├─ 业务逻辑层 (Hooks/Services)                             │
│  ├─ 数据持久化 (IndexedDB/LocalStorage)                     │
│  └─ 通讯层 (Axios + Socket.io-client)                       │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         网关层 (Gateway)                     │
├─────────────────────────────────────────────────────────────┤
│  Nginx反向代理                                               │
│  ├─ 负载均衡                                                │
│  ├─ SSL终止                                                 │
│  ├─ 静态资源服务                                            │
│  └─ WebSocket升级                                           │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层 (Application)                │
├─────────────────────────────────────────────────────────────┤
│  Node.js 后端服务 (Express/Koa/NestJS)                      │
│  ├─ 认证服务 (Auth Service)                                 │
│  ├─ 用户服务 (User Service)                                 │
│  ├─ 消息服务 (Message Service)                              │
│  ├─ 社交服务 (Social Service)                               │
│  ├─ 群组服务 (Group Service)                                │
│  ├─ 通知服务 (Notification Service)                         │
│  ├─ 文件服务 (File Service)                                 │
│  └─ WebSocket服务 (Socket.io Server)                        │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  ├─ 主数据库 (MySQL/MongoDB)                                │
│  ├─ 缓存数据库 (Redis)                                      │
│  ├─ 对象存储 (OSS/S3)                                       │
│  └─ 搜索引擎 (Elasticsearch - 可选)                         │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      第三方服务 (External)                   │
├─────────────────────────────────────────────────────────────┤
│  ├─ 短信服务 (阿里云/腾讯云)                                │
│  ├─ 邮件服务 (SendGrid/阿里云)                              │
│  ├─ 推送服务 (极光推送/个推)                                │
│  └─ 第三方登录 (微信/QQ/微博)                               │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 前端技术栈
- **核心框架**: React 18.2+
- **状态管理**: Redux Toolkit / Zustand
- **UI组件**: Ant Design Mobile 5.x / Vant 4.x
- **路由**: React Router v6
- **HTTP客户端**: Axios 1.x
- **WebSocket**: Socket.io-client 4.x
- **构建工具**: Vite 5.x
- **包管理**: pnpm
- **代码规范**: ESLint + Prettier + Husky
- **CSS方案**: CSS Modules / Styled-Components / TailwindCSS
- **移动端适配**: postcss-px-to-viewport-8-plugin
- **图片处理**: react-image-crop, compressorjs
- **工具库**: lodash-es, dayjs, classnames

#### 后端技术栈
- **运行时**: Node.js 18 LTS
- **Web框架**: Express 4.x / NestJS 10.x
- **WebSocket**: Socket.io 4.x
- **数据库ORM**: Sequelize (MySQL) / Mongoose (MongoDB)
- **认证**: JWT + bcrypt
- **数据验证**: Joi / class-validator
- **日志**: Winston / Pino
- **API文档**: Swagger / OpenAPI
- **任务队列**: Bull (基于Redis)
- **测试**: Jest + Supertest

#### 数据存储
- **关系型数据库**: MySQL 8.0 / PostgreSQL 14
- **NoSQL数据库**: MongoDB 6.0
- **缓存**: Redis 7.0
- **文件存储**: 阿里云OSS / AWS S3 / MinIO
- **搜索引擎**: Elasticsearch 8.x (可选)

#### DevOps
- **容器化**: Docker + Docker Compose
- **CI/CD**: GitHub Actions / GitLab CI
- **部署**: PM2 / Docker / Kubernetes
- **监控**: Prometheus + Grafana
- **日志收集**: ELK Stack
- **反向代理**: Nginx

## 2. 前端架构设计

### 2.1 项目结构

```
social-chat-h5/
├── public/                      # 静态资源
│   ├── favicon.ico
│   └── index.html
├── src/
│   ├── assets/                  # 资源文件
│   │   ├── images/              # 图片
│   │   ├── icons/               # 图标
│   │   └── styles/              # 全局样式
│   │       ├── variables.css    # CSS变量
│   │       ├── reset.css        # 样式重置
│   │       └── common.css       # 公共样式
│   ├── components/              # 通用组件
│   │   ├── Layout/              # 布局组件
│   │   │   ├── Header/
│   │   │   ├── Footer/
│   │   │   ├── TabBar/
│   │   │   └── index.tsx
│   │   ├── ChatBubble/          # 聊天气泡
│   │   ├── UserAvatar/          # 用户头像
│   │   ├── MessageInput/        # 消息输入框
│   │   ├── ImageUpload/         # 图片上传
│   │   ├── AudioRecorder/       # 语音录制
│   │   ├── VideoPlayer/         # 视频播放
│   │   ├── VirtualList/         # 虚拟列表
│   │   ├── PullRefresh/         # 下拉刷新
│   │   └── index.ts             # 组件导出
│   ├── views/                   # 页面组件
│   │   ├── Auth/                # 认证相关
│   │   │   ├── Login/
│   │   │   ├── Register/
│   │   │   └── ForgotPassword/
│   │   ├── Chat/                # 聊天相关
│   │   │   ├── ChatList/        # 会话列表
│   │   │   ├── ChatRoom/        # 聊天室
│   │   │   └── ChatDetail/      # 聊天详情
│   │   ├── Contact/             # 联系人相关
│   │   │   ├── ContactList/     # 好友列表
│   │   │   ├── AddFriend/       # 添加好友
│   │   │   └── FriendRequest/   # 好友请求
│   │   ├── Group/               # 群组相关
│   │   │   ├── GroupList/       # 群组列表
│   │   │   ├── GroupDetail/     # 群组详情
│   │   │   ├── CreateGroup/     # 创建群组
│   │   │   └── GroupMembers/    # 群成员
│   │   ├── Social/              # 社交相关
│   │   │   ├── Timeline/        # 动态时间线
│   │   │   ├── PublishPost/     # 发布动态
│   │   │   └── PostDetail/      # 动态详情
│   │   ├── User/                # 用户相关
│   │   │   ├── Profile/         # 个人资料
│   │   │   ├── Settings/        # 设置
│   │   │   └── EditProfile/     # 编辑资料
│   │   └── Search/              # 搜索
│   ├── store/                   # 状态管理
│   │   ├── slices/              # Redux切片
│   │   │   ├── authSlice.ts     # 认证状态
│   │   │   ├── userSlice.ts     # 用户状态
│   │   │   ├── chatSlice.ts     # 聊天状态
│   │   │   ├── contactSlice.ts  # 联系人状态
│   │   │   ├── groupSlice.ts    # 群组状态
│   │   │   └── socialSlice.ts   # 社交状态
│   │   ├── index.ts             # Store配置
│   │   └── hooks.ts             # Redux Hooks
│   ├── services/                # API服务
│   │   ├── api/                 # API接口
│   │   │   ├── auth.ts          # 认证接口
│   │   │   ├── user.ts          # 用户接口
│   │   │   ├── message.ts       # 消息接口
│   │   │   ├── contact.ts       # 联系人接口
│   │   │   ├── group.ts         # 群组接口
│   │   │   ├── social.ts        # 社交接口
│   │   │   └── file.ts          # 文件接口
│   │   ├── socket/              # WebSocket
│   │   │   ├── index.ts         # Socket连接
│   │   │   ├── events.ts        # 事件定义
│   │   │   └── handlers.ts      # 事件处理
│   │   └── request.ts           # HTTP请求封装
│   ├── hooks/                   # 自定义Hooks
│   │   ├── useAuth.ts           # 认证Hook
│   │   ├── useSocket.ts         # Socket Hook
│   │   ├── useChat.ts           # 聊天Hook
│   │   ├── useInfiniteScroll.ts # 无限滚动
│   │   ├── useDebounce.ts       # 防抖
│   │   ├── useThrottle.ts       # 节流
│   │   └── useLocalStorage.ts   # 本地存储
│   ├── utils/                   # 工具函数
│   │   ├── storage.ts           # 存储工具
│   │   ├── time.ts              # 时间处理
│   │   ├── file.ts              # 文件处理
│   │   ├── validation.ts        # 验证工具
│   │   ├── encryption.ts        # 加密工具
│   │   └── helpers.ts           # 辅助函数
│   ├── types/                   # TypeScript类型
│   │   ├── models/              # 数据模型
│   │   │   ├── user.ts
│   │   │   ├── message.ts
│   │   │   ├── conversation.ts
│   │   │   ├── group.ts
│   │   │   └── post.ts
│   │   ├── api.ts               # API类型
│   │   └── index.ts             # 类型导出
│   ├── router/                  # 路由配置
│   │   ├── index.tsx            # 路由入口
│   │   └── routes.tsx           # 路由定义
│   ├── constants/               # 常量定义
│   │   ├── index.ts             # 通用常量
│   │   └── enums.ts             # 枚举定义
│   ├── config/                  # 配置文件
│   │   ├── index.ts             # 配置入口
│   │   └── env.ts               # 环境变量
│   ├── App.tsx                  # 应用根组件
│   ├── main.tsx                 # 应用入口
│   └── vite-env.d.ts            # Vite类型声明
├── .env.development             # 开发环境变量
├── .env.production              # 生产环境变量
├── .eslintrc.cjs                # ESLint配置
├── .prettierrc                  # Prettier配置
├── tsconfig.json                # TypeScript配置
├── vite.config.ts               # Vite配置
├── package.json                 # 依赖配置
└── README.md                    # 项目说明
```

### 2.2 状态管理架构

#### 2.2.1 Redux Toolkit 状态树设计

```typescript
{
  auth: {
    user: User | null,           // 当前用户
    token: string | null,         // 认证令牌
    isAuthenticated: boolean,     // 是否已认证
    loading: boolean,             // 加载状态
    error: string | null          // 错误信息
  },

  chat: {
    conversations: Conversation[], // 会话列表
    currentConversation: string | null, // 当前会话ID
    messages: {                   // 消息映射
      [conversationId: string]: Message[]
    },
    unreadCount: number,          // 未读总数
    typing: {                     // 正在输入
      [conversationId: string]: string[]
    },
    onlineUsers: string[]         // 在线用户
  },

  contact: {
    friends: User[],              // 好友列表
    groups: string[],             // 好友分组
    requests: FriendRequest[],    // 好友请求
    blacklist: string[]           // 黑名单
  },

  group: {
    groups: Group[],              // 群组列表
    currentGroup: Group | null,   // 当前群组
    members: {                    // 群成员映射
      [groupId: string]: User[]
    }
  },

  social: {
    posts: Post[],                // 动态列表
    currentPost: Post | null,     // 当前动态
    hasMore: boolean,             // 是否有更多
    page: number                  // 当前页码
  },

  ui: {
    theme: 'light' | 'dark',      // 主题
    locale: string,               // 语言
    loading: boolean,             // 全局加载
    toast: Toast | null           // Toast消息
  }
}
```

### 2.3 路由设计

```typescript
// router/routes.tsx
const routes = [
  {
    path: '/',
    element: <Layout />,
    children: [
      {
        index: true,
        element: <Navigate to="/chat" replace />
      },
      {
        path: 'chat',
        element: <ChatList />,
      },
      {
        path: 'chat/:id',
        element: <ChatRoom />
      },
      {
        path: 'contact',
        element: <ContactList />
      },
      {
        path: 'social',
        element: <Timeline />
      },
      {
        path: 'profile',
        element: <Profile />
      }
    ]
  },
  {
    path: '/auth',
    element: <AuthLayout />,
    children: [
      {
        path: 'login',
        element: <Login />
      },
      {
        path: 'register',
        element: <Register />
      }
    ]
  },
  {
    path: '/group',
    children: [
      {
        path: ':id',
        element: <GroupDetail />
      },
      {
        path: 'create',
        element: <CreateGroup />
      }
    ]
  },
  {
    path: '/post',
    children: [
      {
        path: ':id',
        element: <PostDetail />
      },
      {
        path: 'publish',
        element: <PublishPost />
      }
    ]
  },
  {
    path: '/search',
    element: <Search />
  },
  {
    path: '/settings',
    element: <Settings />
  },
  {
    path: '*',
    element: <NotFound />
  }
];
```

### 2.4 WebSocket通讯设计

```typescript
// services/socket/index.ts
class SocketService {
  private socket: Socket | null = null;

  connect(token: string) {
    this.socket = io(SOCKET_URL, {
      auth: { token },
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 5
    });

    this.setupEventHandlers();
  }

  private setupEventHandlers() {
    // 连接事件
    this.socket?.on('connect', this.onConnect);
    this.socket?.on('disconnect', this.onDisconnect);
    this.socket?.on('error', this.onError);

    // 消息事件
    this.socket?.on('message:new', this.onNewMessage);
    this.socket?.on('message:read', this.onMessageRead);
    this.socket?.on('message:delivered', this.onMessageDelivered);

    // 用户事件
    this.socket?.on('user:online', this.onUserOnline);
    this.socket?.on('user:offline', this.onUserOffline);
    this.socket?.on('user:typing', this.onUserTyping);

    // 好友事件
    this.socket?.on('friend:request', this.onFriendRequest);
    this.socket?.on('friend:accepted', this.onFriendAccepted);

    // 群组事件
    this.socket?.on('group:invite', this.onGroupInvite);
    this.socket?.on('group:message', this.onGroupMessage);
  }

  // 发送消息
  sendMessage(data: MessageData) {
    this.socket?.emit('message:send', data);
  }

  // 加入会话
  joinConversation(conversationId: string) {
    this.socket?.emit('conversation:join', conversationId);
  }

  // 离开会话
  leaveConversation(conversationId: string) {
    this.socket?.emit('conversation:leave', conversationId);
  }

  // 输入状态
  setTyping(conversationId: string, isTyping: boolean) {
    this.socket?.emit('typing', { conversationId, isTyping });
  }

  disconnect() {
    this.socket?.disconnect();
  }
}
```

### 2.5 数据缓存策略

#### 2.5.1 IndexedDB存储
- 聊天消息（按会话分组）
- 用户信息（头像、昵称等）
- 会话列表
- 草稿消息

#### 2.5.2 LocalStorage存储
- 用户认证token
- 用户偏好设置
- 主题配置
- 语言设置

#### 2.5.3 Memory缓存
- 当前会话消息
- 在线用户列表
- 输入状态

### 2.6 性能优化策略

1. **代码分割**: 路由懒加载，按需加载组件
2. **虚拟滚动**: 长列表使用虚拟滚动
3. **图片优化**: 懒加载、压缩、WebP格式
4. **请求优化**: 防抖节流、请求合并、取消重复请求
5. **缓存策略**: Service Worker、HTTP缓存、数据缓存
6. **Bundle优化**: Tree Shaking、代码压缩、CDN加载
7. **渲染优化**: React.memo、useMemo、useCallback

## 3. 后端架构设计

### 3.1 项目结构 (NestJS示例)

```
social-chat-api/
├── src/
│   ├── main.ts                  # 应用入口
│   ├── app.module.ts            # 根模块
│   ├── common/                  # 公共模块
│   │   ├── decorators/          # 装饰器
│   │   ├── filters/             # 异常过滤器
│   │   ├── guards/              # 守卫
│   │   ├── interceptors/        # 拦截器
│   │   ├── middleware/          # 中间件
│   │   ├── pipes/               # 管道
│   │   └── utils/               # 工具函数
│   ├── config/                  # 配置
│   │   ├── app.config.ts
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── jwt.config.ts
│   ├── modules/                 # 业务模块
│   │   ├── auth/                # 认证模块
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.module.ts
│   │   │   ├── dto/             # 数据传输对象
│   │   │   ├── guards/          # 认证守卫
│   │   │   └── strategies/      # 认证策略
│   │   ├── user/                # 用户模块
│   │   │   ├── user.controller.ts
│   │   │   ├── user.service.ts
│   │   │   ├── user.module.ts
│   │   │   ├── entities/        # 实体
│   │   │   └── dto/
│   │   ├── message/             # 消息模块
│   │   │   ├── message.controller.ts
│   │   │   ├── message.service.ts
│   │   │   ├── message.module.ts
│   │   │   ├── entities/
│   │   │   └── dto/
│   │   ├── conversation/        # 会话模块
│   │   │   ├── conversation.controller.ts
│   │   │   ├── conversation.service.ts
│   │   │   ├── conversation.module.ts
│   │   │   ├── entities/
│   │   │   └── dto/
│   │   ├── contact/             # 联系人模块
│   │   │   ├── contact.controller.ts
│   │   │   ├── contact.service.ts
│   │   │   ├── contact.module.ts
│   │   │   ├── entities/
│   │   │   └── dto/
│   │   ├── group/               # 群组模块
│   │   │   ├── group.controller.ts
│   │   │   ├── group.service.ts
│   │   │   ├── group.module.ts
│   │   │   ├── entities/
│   │   │   └── dto/
│   │   ├── social/              # 社交模块
│   │   │   ├── social.controller.ts
│   │   │   ├── social.service.ts
│   │   │   ├── social.module.ts
│   │   │   ├── entities/
│   │   │   └── dto/
│   │   ├── file/                # 文件模块
│   │   │   ├── file.controller.ts
│   │   │   ├── file.service.ts
│   │   │   └── file.module.ts
│   │   ├── notification/        # 通知模块
│   │   │   ├── notification.controller.ts
│   │   │   ├── notification.service.ts
│   │   │   └── notification.module.ts
│   │   └── gateway/             # WebSocket网关
│   │       ├── chat.gateway.ts
│   │       ├── events/
│   │       └── dto/
│   └── database/                # 数据库
│       ├── migrations/          # 迁移文件
│       └── seeds/               # 种子数据
├── test/                        # 测试
│   ├── unit/                    # 单元测试
│   └── e2e/                     # 端到端测试
├── .env.development             # 开发环境变量
├── .env.production              # 生产环境变量
├── nest-cli.json                # Nest CLI配置
├── tsconfig.json                # TypeScript配置
├── package.json                 # 依赖配置
└── README.md                    # 项目说明
```

### 3.2 数据库设计

#### 3.2.1 用户表 (users)

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE,
  phone VARCHAR(20) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  nickname VARCHAR(50),
  avatar VARCHAR(255),
  gender ENUM('male', 'female', 'other'),
  birthday DATE,
  region VARCHAR(100),
  signature VARCHAR(200),
  background_image VARCHAR(255),
  status ENUM('active', 'inactive', 'banned') DEFAULT 'active',
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_username (username),
  INDEX idx_email (email),
  INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.2 好友关系表 (friendships)

```sql
CREATE TABLE friendships (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  friend_id BIGINT NOT NULL,
  remark VARCHAR(50),
  group_id BIGINT,
  tags JSON,
  status ENUM('pending', 'accepted', 'blocked') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (friend_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY uk_user_friend (user_id, friend_id),
  INDEX idx_user_id (user_id),
  INDEX idx_friend_id (friend_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.3 会话表 (conversations)

```sql
CREATE TABLE conversations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  type ENUM('private', 'group') NOT NULL,
  group_id BIGINT,
  last_message_id BIGINT,
  last_message_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_type (type),
  INDEX idx_group_id (group_id),
  INDEX idx_last_message_at (last_message_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.4 会话成员表 (conversation_members)

```sql
CREATE TABLE conversation_members (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  conversation_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  unread_count INT DEFAULT 0,
  is_muted BOOLEAN DEFAULT FALSE,
  is_pinned BOOLEAN DEFAULT FALSE,
  last_read_message_id BIGINT,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY uk_conversation_user (conversation_id, user_id),
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.5 消息表 (messages)

```sql
CREATE TABLE messages (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  conversation_id BIGINT NOT NULL,
  sender_id BIGINT NOT NULL,
  content TEXT,
  type ENUM('text', 'image', 'audio', 'video', 'file', 'location') NOT NULL,
  metadata JSON,
  reply_to_id BIGINT,
  status ENUM('sending', 'sent', 'delivered', 'read', 'failed') DEFAULT 'sent',
  is_recalled BOOLEAN DEFAULT FALSE,
  recalled_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
  FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_conversation_id (conversation_id),
  INDEX idx_sender_id (sender_id),
  INDEX idx_created_at (created_at),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.6 群组表 (groups)

```sql
CREATE TABLE groups (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  avatar VARCHAR(255),
  description VARCHAR(500),
  announcement TEXT,
  owner_id BIGINT NOT NULL,
  member_limit INT DEFAULT 500,
  join_type ENUM('free', 'approval', 'invite_only') DEFAULT 'approval',
  is_muted BOOLEAN DEFAULT FALSE,
  status ENUM('active', 'disbanded') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (owner_id) REFERENCES users(id),
  INDEX idx_owner_id (owner_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.7 群成员表 (group_members)

```sql
CREATE TABLE group_members (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  role ENUM('owner', 'admin', 'member') DEFAULT 'member',
  nickname VARCHAR(50),
  is_muted BOOLEAN DEFAULT FALSE,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY uk_group_user (group_id, user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.8 动态表 (posts)

```sql
CREATE TABLE posts (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  content TEXT,
  images JSON,
  video VARCHAR(255),
  location VARCHAR(200),
  visibility ENUM('public', 'friends', 'private') DEFAULT 'friends',
  like_count INT DEFAULT 0,
  comment_count INT DEFAULT 0,
  share_count INT DEFAULT 0,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  INDEX idx_visibility (visibility)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.9 评论表 (comments)

```sql
CREATE TABLE comments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  post_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  content TEXT NOT NULL,
  reply_to_id BIGINT,
  reply_to_user_id BIGINT,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (reply_to_id) REFERENCES comments(id) ON DELETE CASCADE,
  INDEX idx_post_id (post_id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.10 点赞表 (likes)

```sql
CREATE TABLE likes (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  target_type ENUM('post', 'comment') NOT NULL,
  target_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY uk_user_target (user_id, target_type, target_id),
  INDEX idx_target (target_type, target_id),
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.2.11 通知表 (notifications)

```sql
CREATE TABLE notifications (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  type ENUM('message', 'friend_request', 'like', 'comment', 'system') NOT NULL,
  title VARCHAR(100),
  content TEXT,
  data JSON,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_is_read (is_read),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3.3 Redis缓存设计

#### 3.3.1 缓存键设计规范

```
# 用户在线状态
user:online:{userId}           => 1 (TTL: 5分钟)

# 用户信息缓存
user:info:{userId}             => JSON (TTL: 1小时)

# 会话缓存
conversation:{conversationId}  => JSON (TTL: 30分钟)

# 未读消息数
conversation:unread:{userId}   => HASH {conversationId: count}

# 正在输入状态
conversation:typing:{conversationId} => SET [userId1, userId2] (TTL: 5秒)

# 消息去重
message:dedup:{messageId}      => 1 (TTL: 5分钟)

# 验证码
verification:code:{phone/email} => code (TTL: 5分钟)

# 登录token黑名单
auth:blacklist:{token}         => 1 (TTL: token过期时间)

# API限流
rate:limit:{userId}:{endpoint} => counter (TTL: 1分钟)
```

#### 3.3.2 缓存策略

1. **Cache Aside**: 用户信息、会话信息
2. **Write Through**: 未读消息计数
3. **Write Behind**: 在线状态更新
4. **Refresh Ahead**: 热门动态

### 3.4 API设计

#### 3.4.1 RESTful API规范

```
# 认证相关
POST   /api/v1/auth/register              # 注册
POST   /api/v1/auth/login                 # 登录
POST   /api/v1/auth/logout                # 登出
POST   /api/v1/auth/refresh-token         # 刷新token
POST   /api/v1/auth/forgot-password       # 忘记密码
POST   /api/v1/auth/reset-password        # 重置密码

# 用户相关
GET    /api/v1/users/me                   # 获取当前用户信息
PUT    /api/v1/users/me                   # 更新当前用户信息
GET    /api/v1/users/:id                  # 获取用户信息
PUT    /api/v1/users/avatar               # 上传头像
PUT    /api/v1/users/password             # 修改密码

# 好友相关
GET    /api/v1/friends                    # 获取好友列表
POST   /api/v1/friends/request            # 发送好友请求
PUT    /api/v1/friends/request/:id        # 处理好友请求
DELETE /api/v1/friends/:id                # 删除好友
GET    /api/v1/friends/requests           # 获取好友请求列表
PUT    /api/v1/friends/:id/remark         # 设置备注

# 会话相关
GET    /api/v1/conversations              # 获取会话列表
GET    /api/v1/conversations/:id          # 获取会话详情
DELETE /api/v1/conversations/:id          # 删除会话
PUT    /api/v1/conversations/:id/mute     # 设置免打扰
PUT    /api/v1/conversations/:id/pin      # 置顶会话

# 消息相关
GET    /api/v1/conversations/:id/messages # 获取消息列表
POST   /api/v1/messages                   # 发送消息
PUT    /api/v1/messages/:id/recall        # 撤回消息
DELETE /api/v1/messages/:id               # 删除消息
PUT    /api/v1/messages/read              # 标记已读
GET    /api/v1/messages/search            # 搜索消息

# 群组相关
GET    /api/v1/groups                     # 获取群组列表
POST   /api/v1/groups                     # 创建群组
GET    /api/v1/groups/:id                 # 获取群组详情
PUT    /api/v1/groups/:id                 # 更新群组信息
DELETE /api/v1/groups/:id                 # 解散群组
GET    /api/v1/groups/:id/members         # 获取群成员
POST   /api/v1/groups/:id/members         # 添加群成员
DELETE /api/v1/groups/:id/members/:userId # 移除群成员
PUT    /api/v1/groups/:id/members/:userId # 更新成员角色
POST   /api/v1/groups/:id/quit            # 退出群组

# 动态相关
GET    /api/v1/posts                      # 获取动态列表
POST   /api/v1/posts                      # 发布动态
GET    /api/v1/posts/:id                  # 获取动态详情
PUT    /api/v1/posts/:id                  # 更新动态
DELETE /api/v1/posts/:id                  # 删除动态
POST   /api/v1/posts/:id/like             # 点赞动态
DELETE /api/v1/posts/:id/like             # 取消点赞
GET    /api/v1/posts/:id/comments         # 获取评论列表
POST   /api/v1/posts/:id/comments         # 添加评论
DELETE /api/v1/comments/:id               # 删除评论

# 文件相关
POST   /api/v1/files/upload               # 上传文件
GET    /api/v1/files/:id                  # 获取文件
DELETE /api/v1/files/:id                  # 删除文件

# 通知相关
GET    /api/v1/notifications              # 获取通知列表
PUT    /api/v1/notifications/:id/read     # 标记已读
PUT    /api/v1/notifications/read-all     # 全部标记已读
```

#### 3.4.2 WebSocket事件设计

```typescript
// 客户端 -> 服务端
{
  'connection': { token: string },
  'message:send': { conversationId, content, type, metadata },
  'message:read': { conversationId, messageIds },
  'typing:start': { conversationId },
  'typing:stop': { conversationId },
  'conversation:join': { conversationId },
  'conversation:leave': { conversationId }
}

// 服务端 -> 客户端
{
  'connect': {},
  'disconnect': {},
  'error': { code, message },
  'message:new': { message },
  'message:delivered': { messageId, deliveredAt },
  'message:read': { messageId, readBy, readAt },
  'message:recalled': { messageId },
  'user:online': { userId },
  'user:offline': { userId },
  'typing': { conversationId, userId, isTyping },
  'friend:request': { request },
  'friend:accepted': { friendship },
  'group:invite': { group, inviter },
  'group:member_joined': { groupId, user },
  'group:member_left': { groupId, userId },
  'notification': { notification }
}
```

### 3.5 安全设计

#### 3.5.1 认证授权
- JWT Token认证
- Access Token + Refresh Token双token机制
- Token过期时间: Access(2小时), Refresh(7天)
- 密码使用bcrypt加密(salt rounds: 10)

#### 3.5.2 接口安全
- HTTPS传输加密
- CORS跨域配置
- XSS防护(内容转义)
- CSRF防护(Token验证)
- SQL注入防护(参数化查询)
- 接口签名验证

#### 3.5.3 限流策略
- 登录接口: 5次/分钟/IP
- 短信发送: 1次/分钟/手机号, 10次/天
- 消息发送: 100次/分钟/用户
- 文件上传: 20次/小时/用户
- API总调用: 1000次/分钟/用户

#### 3.5.4 敏感信息
- 密码加密存储
- Token加密传输
- 用户手机号脱敏显示
- 聊天内容可选端到端加密

## 4. 部署架构

### 4.1 开发环境

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # 前端开发服务
  frontend:
    build:
      context: ./social-chat-h5
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./social-chat-h5:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development

  # 后端API服务
  backend:
    build:
      context: ./social-chat-api
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./social-chat-api:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mysql://root:password@mysql:3306/social_chat
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mysql
      - redis

  # MySQL数据库
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=social_chat
    volumes:
      - mysql_data:/var/lib/mysql

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # MinIO对象存储
  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

volumes:
  mysql_data:
  redis_data:
  minio_data:
```

### 4.2 生产环境

```
                         Internet
                            |
                    [负载均衡 - ALB]
                            |
                ┌───────────┴───────────┐
                |                       |
            [Nginx 1]              [Nginx 2]
         (静态资源/反向代理)
                |                       |
        ┌───────┴───────┐       ┌───────┴───────┐
        |               |       |               |
    [Node.js 1]   [Node.js 2] [Node.js 3]  [Node.js 4]
    (API Server + WebSocket)
        |               |       |               |
        └───────┬───────┘       └───────┬───────┘
                |                       |
        ┌───────┴───────────────────────┴───────┐
        |               |               |       |
    [MySQL          [Redis         [MongoDB  [OSS]
     Master]         Cluster]       Cluster]
        |
    [MySQL Slave]
```

### 4.3 CI/CD流程

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Frontend
        run: |
          cd social-chat-h5
          npm install
          npm run build

      - name: Build Backend
        run: |
          cd social-chat-api
          npm install
          npm run build

      - name: Build Docker Images
        run: |
          docker build -t social-chat-frontend ./social-chat-h5
          docker build -t social-chat-backend ./social-chat-api

      - name: Push to Registry
        run: |
          docker push social-chat-frontend
          docker push social-chat-backend

      - name: Deploy to Production
        run: |
          kubectl apply -f k8s/
```

## 5. 监控与日志

### 5.1 监控指标

#### 5.1.1 应用监控
- QPS (每秒查询数)
- 响应时间 (P50, P95, P99)
- 错误率
- 在线用户数
- WebSocket连接数

#### 5.1.2 系统监控
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络IO

#### 5.1.3 业务监控
- 消息发送成功率
- 消息延迟
- 用户活跃度
- 功能使用率

### 5.2 日志管理

#### 5.2.1 日志级别
- ERROR: 错误日志
- WARN: 警告日志
- INFO: 信息日志
- DEBUG: 调试日志

#### 5.2.2 日志收集
- 应用日志 -> Winston/Pino -> Filebeat -> Elasticsearch -> Kibana
- Nginx日志 -> Filebeat -> Elasticsearch -> Kibana
- 系统日志 -> Filebeat -> Elasticsearch -> Kibana

## 6. 扩展性设计

### 6.1 水平扩展
- 无状态服务设计
- 使用Redis共享session
- WebSocket使用Redis Pub/Sub实现多实例通信
- 数据库读写分离
- 分库分表策略

### 6.2 垂直扩展
- 服务器升级
- 数据库优化
- 缓存优化

### 6.3 微服务拆分 (未来)
- 用户服务
- 消息服务
- 社交服务
- 文件服务
- 通知服务

## 7. 技术风险与应对

### 7.1 并发问题
**风险**: 高并发下的性能瓶颈
**应对**:
- Redis缓存热点数据
- 消息队列削峰
- 数据库连接池
- 读写分离

### 7.2 消息可靠性
**风险**: 消息丢失或重复
**应对**:
- 消息确认机制
- 消息去重
- 断线重连
- 消息持久化

### 7.3 数据一致性
**风险**: 缓存与数据库不一致
**应对**:
- 合理的缓存更新策略
- 分布式锁
- 事务处理

### 7.4 安全风险
**风险**: 数据泄露、攻击
**应对**:
- HTTPS加密
- 接口鉴权
- 限流防刷
- 敏感信息加密

## 8. 开发规范

### 8.1 代码规范
- ESLint + Prettier统一代码风格
- TypeScript严格模式
- Git Commit规范 (Conventional Commits)
- Code Review流程

### 8.2 接口规范
- RESTful API设计
- 统一响应格式
- 错误码定义
- API版本管理

### 8.3 数据库规范
- 命名规范
- 索引设计
- 迁移管理
- 备份策略

### 8.4 测试规范
- 单元测试覆盖率 > 80%
- 集成测试
- E2E测试
- 性能测试

## 9. 项目时间线

### Phase 1: 基础架构搭建 (2周)
- 项目初始化
- 开发环境搭建
- 基础框架搭建
- CI/CD配置

### Phase 2: 核心功能开发 (6周)
- 用户系统 (1周)
- 即时通讯 (3周)
- 好友系统 (1周)
- 文件上传 (1周)

### Phase 3: 社交功能开发 (4周)
- 动态广场 (2周)
- 群组功能 (2周)

### Phase 4: 优化与测试 (2周)
- 性能优化
- 安全加固
- 测试完善
- Bug修复

### Phase 5: 上线准备 (1周)
- 生产环境部署
- 压力测试
- 灰度发布

## 10. 附录

### 10.1 技术选型对比

#### 前端框架
| 框架 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| React | 生态丰富、社区活跃 | 学习曲线陡峭 | 大中型项目 |
| Vue | 简单易学、渐进式 | 生态相对较小 | 中小型项目 |

#### 后端框架
| 框架 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| Express | 简单灵活、轻量级 | 缺少规范 | 小型项目 |
| NestJS | 架构完善、TypeScript | 学习成本高 | 大中型项目 |

#### 数据库
| 数据库 | 优点 | 缺点 | 适用场景 |
|--------|------|------|----------|
| MySQL | 成熟稳定、事务支持 | 横向扩展困难 | 关系型数据 |
| MongoDB | 灵活、易扩展 | 事务支持弱 | 文档型数据 |

### 10.2 参考资料
- React官方文档: https://react.dev
- NestJS官方文档: https://nestjs.com
- Socket.io文档: https://socket.io
- Redis最佳实践
- MySQL性能优化指南

---

**文档版本**: v1.0
**创建日期**: 2025-11-06
**最后更新**: 2025-11-06
**文档作者**: 技术团队
**审核状态**: 待审核
